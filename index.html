<!doctype html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Zentrale</title>

    <link rel="manifest" href="./manifest.webmanifest">
    <meta name="theme-color" content="#0b0f14">

    <!-- iOS (optional aber empfohlen) -->
    <link rel="apple-touch-icon" href="./icons/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">


    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>




    <style>
        :root{ --card-radius: 18px; }

        body{
            background:
                    radial-gradient(1200px 600px at 20% 0%, #1b3a2a 0%, rgba(27,58,42,0) 55%),
                    radial-gradient(1000px 500px at 80% 10%, #2a1b3a 0%, rgba(42,27,58,0) 55%),
                    #0b0f14;
            color:#e9eef5;
        }

        .navbar{
            backdrop-filter: blur(10px);
            background: rgba(10, 14, 20, 0.65) !important;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }

        .card{
            border: 1px solid rgba(255,255,255,0.10);
            background: rgba(255,255,255,0.06);
            border-radius: var(--card-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.35);
        }

        .form-control, .form-select{
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.12);
            color: #e9eef5;
        }

        .form-control::placeholder{ color: rgba(233,238,245,0.60); }

        .form-control:focus, .form-select:focus{
            box-shadow: 0 0 0 .25rem rgba(13,110,253,0.18);
            border-color: rgba(13,110,253,0.55);
        }

        .badge-soft{
            background: rgba(255,255,255,0.12);
            border: 1px solid rgba(255,255,255,0.12);
            color: #e9eef5;
        }

        .small-muted{ color: rgba(233,238,245,0.72); }

        .amount-pos{ color:#57e389; font-variant-numeric: tabular-nums; }
        .amount-neg{ color:#ff6b6b; font-variant-numeric: tabular-nums; }
        .amount-zero{ color:#cbd5e1; font-variant-numeric: tabular-nums; }

        canvas{ max-height: 360px; }

        .modal-content{
            border: 1px solid rgba(255,255,255,0.10);
            background: rgba(12, 16, 22, 0.95);
            border-radius: 18px;
        }

        .nav-pills .nav-link{ border-radius: 999px; }
        .nav-pills .nav-link.active{ background: rgba(13,110,253,0.85); }

        /* ===== Tables: readable on light table backgrounds inside cards ===== */
        .table{
            color: #0f172a;
            background: rgba(255,255,255,0.90);
            border-radius: 12px;
            overflow: hidden;
        }
        .table thead th{
            background: rgba(248,250,252,0.95);
            color: #0f172a;
            border-bottom: 1px solid rgba(15,23,42,0.12);
        }
        .table tbody td{
            color: #0f172a;
            border-color: rgba(15,23,42,0.10);
        }
        .table-hover > tbody > tr:hover > *{
            background: rgba(13,110,253,0.06);
            color: #0f172a;
        }
        .table .small-muted{ color: rgba(15,23,42,0.72); }

        /* Buttons: avoid white outline on dark background */
        .btn-outline-light{
            color: rgba(233,238,245,0.92);
            border-color: rgba(233,238,245,0.35);
        }
        .btn-outline-light:hover{
            color:#0b0f14;
            background: rgba(233,238,245,0.92);
            border-color: rgba(233,238,245,0.92);
        }
        .btn-outline-danger{
            border-color: rgba(220,53,69,0.65);
        }
        .btn-outline-danger:hover{
            background: rgba(220,53,69,0.92);
            border-color: rgba(220,53,69,0.92);
        }

        /* Profile UI */
        .avatar{
            width: 34px;
            height: 34px;
            border-radius: 999px;
            object-fit: cover;
            border: 1px solid rgba(255,255,255,0.20);
            background: rgba(255,255,255,0.10);
        }

        /* Podium */
        .podium{
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            align-items: end;
            margin-bottom: 14px;
        }
        .podium-step{
            border-radius: 14px;
            padding: 10px 10px 12px;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.10);
            text-align: center;
        }
        .podium-step.step-1{ min-height: 210px; }
        .podium-step.step-2{ min-height: 180px; }
        .podium-step.step-3{ min-height: 165px; }
        .podium-rank{
            font-weight: 700;
            letter-spacing: 0.5px;
            opacity: 0.95;
        }
        .podium-avatar{
            width: 72px;
            height: 72px;
            border-radius: 999px;
            object-fit: cover;
            border: 1px solid rgba(255,255,255,0.18);
            background: rgba(255,255,255,0.10);
            margin: 10px auto 8px;
            display:block;
        }
        .podium-name{ font-weight: 700; margin-bottom: 2px; }
        .podium-value{ font-variant-numeric: tabular-nums; }

        .lb-avatar{
            width: 28px;
            height: 28px;
            border-radius: 999px;
            object-fit: cover;
            border: 1px solid rgba(15,23,42,0.18);
            background: rgba(15,23,42,0.06);
            margin-right: 10px;
        }
    </style>
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-dark sticky-top">
    <div class="container py-2">
        <a class="navbar-brand fw-semibold" href="#">Zentrale</a>

        <div class="ms-auto d-flex gap-2 align-items-center">
            <span class="badge badge-soft" id="authStatus">Nicht eingeloggt</span>

            <!-- Profile (only when logged in) -->
            <div class="dropdown d-none" id="profileMenuWrap">
                <button class="btn btn-sm btn-outline-light d-flex align-items-center gap-2 dropdown-toggle"
                        type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <img id="navAvatar" class="avatar" alt="Profilbild">
                    <span id="navUsername" class="d-none d-sm-inline">Profil</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                        <a class="dropdown-item d-none" id="adminLink" href="./admin.html">
                            Admin Panel
                        </a>
                    </li>
                    <li><hr class="dropdown-divider"></li>

                    <li>
                        <a class="dropdown-item d-none" id="setupLink" href="./setup.html">
                            Turnier Setup Panel
                        </a>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li><button class="dropdown-item" id="btnOpenProfile" type="button">Profil bearbeiten</button></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><button class="dropdown-item text-danger" id="btnLogout" type="button">Logout</button></li>
                </ul>
            </div>
        </div>
    </div>
</nav>

<main class="container my-4">

    <!-- AUTH AREA -->
    <div id="authArea" class="row g-3">
        <div class="col-12 col-lg-6">
            <div class="card p-3 p-md-4 h-100">
                <h1 class="h4 mb-1" style="color: #fff">Login</h1>
                <div class="small-muted mb-3">Melde dich an, um deine Einträge zu verwalten.</div>

                <form id="loginForm" class="row g-2">
                    <div class="col-12">
                        <label class="form-label small-muted mb-1">E-Mail</label>
                        <input class="form-control" type="email" id="loginEmail" required>
                    </div>
                    <div class="col-12">
                        <label class="form-label small-muted mb-1">Passwort</label>
                        <input class="form-control" type="password" id="loginPassword" required>
                    </div>
                    <div class="col-12 d-grid mt-2">
                        <button class="btn btn-primary btn-lg" type="submit">Einloggen</button>
                    </div>
                </form>

                <hr class="border border-light border-opacity-10 my-3">

                <div class="d-grid">
                    <button class="btn btn-outline-light" id="btnGoogle" type="button">Mit Google einloggen</button>
                </div>

                <div class="small text-danger mt-3" id="authMsg"></div>
            </div>
        </div>

        <div class="col-12 col-lg-6">
            <div class="card p-3 p-md-4 h-100">
                <h2 class="h4 mb-1" style="color: #fff">Registrieren</h2>
                <div class="small-muted mb-3">Account erstellen (E-Mail & Passwort). Username wird sofort gesetzt.</div>

                <form id="registerForm" class="row g-2">
                    <div class="col-12">
                        <label class="form-label small-muted mb-1">Username (für Leaderboard)</label>
                        <input class="form-control" id="regUsername" maxlength="20" placeholder="z. B. PokerAlex" required>
                        <div class="small-muted mt-1">3–20 Zeichen, nur Buchstaben/Zahlen/_. Muss eindeutig sein.</div>
                    </div>
                    <div class="col-12">
                        <label class="form-label small-muted mb-1">E-Mail</label>
                        <input class="form-control" type="email" id="regEmail" required>
                    </div>
                    <div class="col-12">
                        <label class="form-label small-muted mb-1">Passwort</label>
                        <input class="form-control" type="password" id="regPassword" minlength="6" required>
                    </div>
                    <div class="col-12 d-grid mt-2">
                        <button class="btn btn-success btn-lg" type="submit">Account erstellen</button>
                    </div>
                </form>

                <div class="small-muted mt-3">
                    Hinweis: Google-Login erfordert beim ersten Login ebenfalls einen Username.
                </div>
            </div>
        </div>
    </div>

    <!-- APP AREA -->
    <div id="appArea" class="d-none">

        <!-- Header -->
        <div class="row g-3 mb-3">
            <div class="col-12">
                <div class="card p-3 p-md-4">
                    <div class="d-flex justify-content-between align-items-start gap-3 flex-wrap">
                        <div>
                            <h1 class="h2 mb-1" style="color:#fff;" id="whoAmI"></h1>
                        </div>
                        <div class="text-end">
                            <div class="small-muted">Mein Gesamt</div>
                            <div class="display-6 fw-semibold" id="kpiTotal">0,00 €</div>
                            <!-- NEU: Performance-Text (besser als X% etc.) -->
                            <div class="small-muted mt-1" id="kpiPerformance">—</div>
                        </div>
                    </div>

                    <hr class="border border-light border-opacity-10 my-3">

                    <ul class="nav nav-pills gap-2" id="mainTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="tabCashBtn" data-bs-toggle="pill" data-bs-target="#tabCash"
                                    type="button" role="tab" aria-controls="tabCash" aria-selected="true">
                                Cashgame
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tabTourBtn" data-bs-toggle="pill" data-bs-target="#tabTour"
                                    type="button" role="tab" aria-controls="tabTour" aria-selected="false">
                                Turnier
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tabLeadBtn" data-bs-toggle="pill" data-bs-target="#tabLead"
                                    type="button" role="tab" aria-controls="tabLead" aria-selected="false">
                                Leaderboard
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="tab-content">

            <!-- CASHGAME TAB -->
            <div class="tab-pane fade show active" id="tabCash" role="tabpanel" aria-labelledby="tabCashBtn">
                <div class="row g-3 mb-3">
                    <!-- KPIs Cash -->
                    <div class="col-12 col-lg-4">
                        <div class="card p-3 p-md-4 h-100">
                            <h2 class="h5 mb-3" style="color:#fff;">Cashgame Stats</h2>
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="small-muted">Cashgame Gesamt</div>
                                    <div class="h3 mb-0" id="kpiCashTotal">0,00 €</div>
                                </div>
                                <div class="col-6">
                                    <div class="small-muted">Einträge</div>
                                    <div class="h4 mb-0" id="kpiCashCount" style="color: #fff">0</div>
                                </div>
                                <div class="col-6">
                                    <div class="small-muted">Ø pro Eintrag</div>
                                    <div class="h4 mb-0" id="kpiCashAvg">0,00 €</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Form Cash -->
                    <div class="col-12 col-lg-4">
                        <div class="card p-3 p-md-4 h-100">
                            <h2 class="h5 mb-3" style="color:#fff;">Cashgame Eintrag</h2>
                            <div class="row g-2">
                                <div class="col-12">
                                    <label class="form-label small-muted mb-1">Datum</label>
                                    <input class="form-control" type="date" id="cashDate" required>
                                </div>
                                <div class="col-12">
                                    <label class="form-label small-muted mb-1">Betrag (Gewinn + / Verlust −)</label>
                                    <input class="form-control" type="number" id="cashAmount" step="0.01" placeholder="z. B. 25 oder -10" required>
                                </div>
                                <div class="col-12">
                                    <label class="form-label small-muted mb-1">Notiz</label>
                                    <input class="form-control" id="cashNote" maxlength="80" placeholder="z. B. 1/2 NLH, Homegame …">
                                </div>
                                <div class="col-12 d-grid mt-2">
                                    <button class="btn btn-primary btn-lg" id="btnAddCash" type="button">Speichern</button>
                                </div>
                                <div class="small text-danger mt-2" id="cashMsg"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Chart Cash -->
                    <div class="col-12 col-lg-4">
                        <div class="card p-3 p-md-4 h-100">
                            <h2 class="h5 mb-2" style="color:#fff;">Cashgame Chart</h2>
                            <div class="small-muted mb-2">Kumuliert nach Datum.</div>
                            <canvas id="cashChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Cash table -->
                <div class="row g-3">
                    <div class="col-12">
                        <div class="card p-3 p-md-4">
                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                <div>
                                    <h2 class="h5 mb-0" style="color:#fff;">Cashgame Tabelle</h2>
                                    <div class="small-muted">Nur deine Cashgame-Einträge.</div>
                                </div>
                                <span class="badge badge-soft">EUR</span>
                            </div>

                            <hr class="border border-light border-opacity-10 my-3">

                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead>
                                    <tr>
                                        <th>Datum</th>
                                        <th class="text-end">Betrag</th>
                                        <th>Notiz</th>
                                        <th class="text-end">Aktion</th>
                                    </tr>
                                    </thead>
                                    <tbody id="tbodyCash"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TOURNAMENT TAB -->
            <div class="tab-pane fade" id="tabTour" role="tabpanel" aria-labelledby="tabTourBtn">
                <div class="row g-3 mb-3">
                    <!-- KPIs Tour -->
                    <div class="col-12 col-lg-4">
                        <div class="card p-3 p-md-4 h-100">
                            <h2 class="h5 mb-3" style="color:#fff;">Turnier Stats</h2>
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="small-muted">Turnier Gesamt</div>
                                    <div class="h3 mb-0" id="kpiTourTotal">0,00 €</div>
                                </div>
                                <div class="col-6">
                                    <div class="small-muted">Einträge</div>
                                    <div class="h4 mb-0" id="kpiTourCount" style="color: #fff">0</div>
                                </div>
                                <div class="col-6">
                                    <div class="small-muted">Ø pro Eintrag</div>
                                    <div class="h4 mb-0" id="kpiTourAvg">0,00 €</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Form Tour -->
                    <div class="col-12 col-lg-4">
                        <div class="card p-3 p-md-4 h-100">
                            <h2 class="h5 mb-3" style="color:#fff;">Turnier Eintrag</h2>
                            <div class="row g-2">
                                <div class="col-12">
                                    <label class="form-label small-muted mb-1">Datum</label>
                                    <input class="form-control" type="date" id="tourDate" required>
                                </div>
                                <div class="col-12">
                                    <label class="form-label small-muted mb-1">Betrag (Gewinn + / Verlust −)</label>
                                    <input class="form-control" type="number" id="tourAmount" step="0.01" placeholder="z. B. 80 oder -50" required>
                                </div>
                                <div class="col-12">
                                    <label class="form-label small-muted mb-1">Notiz</label>
                                    <input class="form-control" id="tourNote" maxlength="80" placeholder="z. B. Buy-in 50€, Rebuy …">
                                </div>
                                <div class="col-12 d-grid mt-2">
                                    <button class="btn btn-primary btn-lg" id="btnAddTour" type="button">Speichern</button>
                                </div>
                                <div class="small text-danger mt-2" id="tourMsg"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Chart Tour -->
                    <div class="col-12 col-lg-4">
                        <div class="card p-3 p-md-4 h-100">
                            <h2 class="h5 mb-2" style="color:#fff;">Turnier Chart</h2>
                            <div class="small-muted mb-2">Kumuliert nach Datum.</div>
                            <canvas id="tourChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Tour table -->
                <div class="row g-3">
                    <div class="col-12">
                        <div class="card p-3 p-md-4">
                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                <div>
                                    <h2 class="h5 mb-0" style="color:#fff;">Turnier Tabelle</h2>
                                    <div class="small-muted">Nur deine Turnier-Einträge.</div>
                                </div>
                                <span class="badge badge-soft">EUR</span>
                            </div>

                            <hr class="border border-light border-opacity-10 my-3">

                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead>
                                    <tr>
                                        <th>Datum</th>
                                        <th class="text-end">Betrag</th>
                                        <th>Notiz</th>
                                        <th class="text-end">Aktion</th>
                                    </tr>
                                    </thead>
                                    <tbody id="tbodyTour"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- LEADERBOARD TAB -->
            <div class="tab-pane fade" id="tabLead" role="tabpanel" aria-labelledby="tabLeadBtn">
                <div class="row g-3">

                    <!-- Cashgame Leaderboard -->
                    <div class="col-12 col-lg-6">
                        <div class="card p-3 p-md-4 h-100">
                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                <div>
                                    <h2 class="h5 mb-0" style="color:#fff;">Leaderboard – Cashgame</h2>
                                </div>
                                <span class="badge badge-soft">Top 50</span>
                            </div>

                            <hr class="border border-light border-opacity-10 my-3">

                            <!-- Podium Cash -->
                            <div class="podium">
                                <div class="podium-step step-2" id="podiumCash2"></div>
                                <div class="podium-step step-1" id="podiumCash1"></div>
                                <div class="podium-step step-3" id="podiumCash3"></div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Spieler</th>
                                        <th class="text-end">Cashgame</th>
                                    </tr>
                                    </thead>
                                    <tbody id="tbodyLeaderboardCash"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Tournament Leaderboard -->
                    <div class="col-12 col-lg-6">
                        <div class="card p-3 p-md-4 h-100">
                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                <div>
                                    <h2 class="h5 mb-0" style="color:#fff;">Leaderboard – Turnier</h2>
                                </div>
                                <span class="badge badge-soft">Top 50</span>
                            </div>

                            <hr class="border border-light border-opacity-10 my-3">

                            <!-- Podium Tour -->
                            <div class="podium">
                                <div class="podium-step step-2" id="podiumTour2"></div>
                                <div class="podium-step step-1" id="podiumTour1"></div>
                                <div class="podium-step step-3" id="podiumTour3"></div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Spieler</th>
                                        <th class="text-end">Turnier</th>
                                    </tr>
                                    </thead>
                                    <tbody id="tbodyLeaderboardTour"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Total / Gesamt Leaderboard -->
                    <div class="col-12">
                        <div class="card p-3 p-md-4">
                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                <div>
                                    <h2 class="h5 mb-0" style="color:#fff;">Leaderboard – Gesamt</h2>
                                </div>
                                <span class="badge badge-soft">Top 50</span>
                            </div>

                            <hr class="border border-light border-opacity-10 my-3">

                            <!-- Podium Total -->
                            <div class="podium">
                                <div class="podium-step step-2" id="podiumTotal2"></div>
                                <div class="podium-step step-1" id="podiumTotal1"></div>
                                <div class="podium-step step-3" id="podiumTotal3"></div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Spieler</th>
                                        <th class="text-end">Gesamt</th>
                                    </tr>
                                    </thead>
                                    <tbody id="tbodyLeaderboardTotal"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>


                    <div class="col-12">
                        <div class="small-muted"></div>
                    </div>

                </div>
            </div>
        </div><!-- /tab-content -->
    </div><!-- /appArea -->
</main>

<!-- USERNAME MODAL -->
<div class="modal fade" id="usernameModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-light">
            <div class="modal-header border-0">
                <h5 class="modal-title">Username festlegen</h5>
            </div>
            <div class="modal-body">
                <p class="small-muted mb-2">
                    Bitte wähle einen <strong>eindeutigen Username</strong> (3–20 Zeichen, nur Buchstaben/Zahlen/_).
                </p>
                <label class="form-label small-muted mb-1">Username</label>
                <input class="form-control" id="usernameInput" maxlength="20" placeholder="z. B. PokerAlex" autocomplete="off">
                <div class="small text-danger mt-2" id="usernameError"></div>
            </div>
            <div class="modal-footer border-0">
                <button class="btn btn-primary" id="saveUsernameBtn" type="button">Speichern</button>
            </div>
        </div>
    </div>
</div>

<!-- PROFILE MODAL -->
<div class="modal fade" id="profileModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-light">
            <div class="modal-header border-0">
                <h5 class="modal-title">Profil bearbeiten</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Schließen"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex align-items-center gap-3 mb-3">
                    <img id="profilePreview" class="podium-avatar" alt="Profilbild">
                    <div>
                        <div class="small-muted mb-1">Profilbild</div>
                        <input class="form-control form-control-sm" type="file" id="profilePhotoFile" accept="image/*">
                        <div class="small-muted mt-1">Empfehlung: quadratisch, max. ~200 KB.</div>
                    </div>
                </div>

                <label class="form-label small-muted mb-1">Username</label>
                <input class="form-control" id="profileUsername" maxlength="20">

                <div class="small text-danger mt-2" id="profileMsg"></div>
            </div>
            <div class="modal-footer border-0">
                <button class="btn btn-outline-light" data-bs-dismiss="modal" type="button">Abbrechen</button>
                <button class="btn btn-primary" id="btnSaveProfile" type="button">Speichern</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
    // Firebase imports (modular SDK via CDN)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import {
        getAuth, onAuthStateChanged, signOut,
        signInWithEmailAndPassword, createUserWithEmailAndPassword,
        GoogleAuthProvider, signInWithPopup
    } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import {
        getFirestore, doc, setDoc, getDoc,
        collection, addDoc, deleteDoc,
        query, where, orderBy, onSnapshot, getDocs,
        serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyASN7beVlrbMtUwMr4BKfSx1EmUQZJAfNk",
        authDomain: "zentrale-ee675.firebaseapp.com",
        projectId: "zentrale-ee675",
        storageBucket: "zentrale-ee675.firebasestorage.app",
        messagingSenderId: "1091342474994",
        appId: "1:1091342474994:web:29ff79685bbd4e5077fa6b",
        measurementId: "G-S805TDBQCQ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM refs
    const authArea = document.getElementById("authArea");
    const appArea = document.getElementById("appArea");
    const authStatus = document.getElementById("authStatus");
    const authMsg = document.getElementById("authMsg");

    const profileMenuWrap = document.getElementById("profileMenuWrap");
    const navAvatar = document.getElementById("navAvatar");
    const navUsername = document.getElementById("navUsername");
    const btnOpenProfile = document.getElementById("btnOpenProfile");
    const btnLogout = document.getElementById("btnLogout");

    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("registerForm");
    const btnGoogle = document.getElementById("btnGoogle");

    const whoAmI = document.getElementById("whoAmI");
    const kpiTotal = document.getElementById("kpiTotal");
    const kpiPerformance = document.getElementById("kpiPerformance");

    // Cash UI
    const cashDate = document.getElementById("cashDate");
    const cashAmount = document.getElementById("cashAmount");
    const cashNote = document.getElementById("cashNote");
    const btnAddCash = document.getElementById("btnAddCash");
    const cashMsg = document.getElementById("cashMsg");
    const tbodyCash = document.getElementById("tbodyCash");
    const kpiCashTotal = document.getElementById("kpiCashTotal");
    const kpiCashCount = document.getElementById("kpiCashCount");
    const kpiCashAvg = document.getElementById("kpiCashAvg");

    // Tournament UI
    const tourDate = document.getElementById("tourDate");
    const tourAmount = document.getElementById("tourAmount");
    const tourNote = document.getElementById("tourNote");
    const btnAddTour = document.getElementById("btnAddTour");
    const tourMsg = document.getElementById("tourMsg");
    const tbodyTour = document.getElementById("tbodyTour");
    const kpiTourTotal = document.getElementById("kpiTourTotal");
    const kpiTourCount = document.getElementById("kpiTourCount");
    const kpiTourAvg = document.getElementById("kpiTourAvg");

    // Leaderboards
    const tbodyLeaderboardCash = document.getElementById("tbodyLeaderboardCash");
    const tbodyLeaderboardTour = document.getElementById("tbodyLeaderboardTour");
    const podiumCash1 = document.getElementById("podiumCash1");
    const podiumCash2 = document.getElementById("podiumCash2");
    const podiumCash3 = document.getElementById("podiumCash3");
    const podiumTour1 = document.getElementById("podiumTour1");
    const podiumTour2 = document.getElementById("podiumTour2");
    const podiumTour3 = document.getElementById("podiumTour3");



    const tbodyLeaderboardTotal = document.getElementById("tbodyLeaderboardTotal");
    const podiumTotal1 = document.getElementById("podiumTotal1");
    const podiumTotal2 = document.getElementById("podiumTotal2");
    const podiumTotal3 = document.getElementById("podiumTotal3");

    const qCash = query(collection(db, "users"), orderBy("cashgameTotalEUR", "desc"));
    const qTour = query(collection(db, "users"), orderBy("tournamentTotalEUR", "desc"));
    const qTotal = query(collection(db, "users"), orderBy("totalEUR", "desc"));



    // Username modal
    const usernameModalEl = document.getElementById("usernameModal");
    const usernameInput = document.getElementById("usernameInput");
    const usernameError = document.getElementById("usernameError");
    const saveUsernameBtn = document.getElementById("saveUsernameBtn");
    const usernameModal = new window.bootstrap.Modal(usernameModalEl);

    // Profile modal
    const profileModalEl = document.getElementById("profileModal");
    const profileModal = new window.bootstrap.Modal(profileModalEl);
    const profilePreview = document.getElementById("profilePreview");
    const profilePhotoFile = document.getElementById("profilePhotoFile");
    const profileUsername = document.getElementById("profileUsername");
    const profileMsg = document.getElementById("profileMsg");
    const btnSaveProfile = document.getElementById("btnSaveProfile");

    // Helpers
    const fmt = new Intl.NumberFormat("de-DE", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const formatEUR = (amount) => `${fmt.format(Number(amount || 0))} €`;

    function amountClass(amount){
        amount = Number(amount || 0);
        if(amount > 0) return "amount-pos";
        if(amount < 0) return "amount-neg";
        return "amount-zero";
    }

    function todayISO(){ return new Date().toISOString().slice(0,10); }
    cashDate.value = todayISO();
    tourDate.value = todayISO();

    function escapeHtml(str){
        return (str ?? "").toString()
            .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
            .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function isValidUsername(u){
        return /^[a-zA-Z0-9_]{3,20}$/.test(u);
    }

    function setAuthUI(isLoggedIn){
        authArea.classList.toggle("d-none", isLoggedIn);
        appArea.classList.toggle("d-none", !isLoggedIn);
        profileMenuWrap.classList.toggle("d-none", !isLoggedIn);
        authStatus.textContent = isLoggedIn ? "Eingeloggt" : "Nicht eingeloggt";
    }

    // Default avatar (SVG data url)
    function defaultAvatarDataUrl(){
        const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 128 128">
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#334155"/>
            <stop offset="1" stop-color="#0f172a"/>
          </linearGradient>
        </defs>
        <rect width="128" height="128" rx="64" fill="url(#g)"/>
        <circle cx="64" cy="52" r="22" fill="#e2e8f0" opacity="0.9"/>
        <path d="M22,118c8-24,30-34,42-34s34,10,42,34" fill="#e2e8f0" opacity="0.9"/>
      </svg>
    `.trim();
        return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
    }

    function setNavProfile(username, photoDataUrl){
        navUsername.textContent = username || "Profil";
        navAvatar.src = photoDataUrl || defaultAvatarDataUrl();
        profilePreview.src = photoDataUrl || defaultAvatarDataUrl();
    }

    // Performance helpers (besser als X% etc.)
    function percentileRankDesc(values, myValue){
        const xs = values
            .map(v => Number(v))
            .filter(v => Number.isFinite(v))
            .sort((a,b)=> b-a);

        if(xs.length === 0) return null;

        const better = xs.filter(v => v > myValue).length;
        const equal  = xs.filter(v => v === myValue).length;

        const rankMid = better + (equal * 0.5);
        return 1 - (rankMid / xs.length); // 1=top, 0=bottom
    }

    function formatPerformanceText({ myValue, values }){
        const p = percentileRankDesc(values, myValue);
        if(p === null) return "—";
        if(values.length < 5) return "Vergleich: zu wenige Daten.";

        const topPct = Math.max(1, Math.round((1 - p) * 100));
        const betterThan = Math.max(0, Math.round(p * 100));

        if(topPct <= 15){
            return `Du bist Top ${topPct}% (besser als ${betterThan}% aller Spieler).`;
        }
        return `Du performst besser als ${betterThan}% aller Spieler.`;
    }


    function performanceVsAll(values, myValue){
        const xs = values
            .map(v => Number(v))
            .filter(v => Number.isFinite(v));

        const n = xs.length;
        if(n <= 1) return { text: "Vergleich: zu wenige Daten.", rank: null, n };

        const lower = xs.filter(v => v < myValue).length;
        const higher = xs.filter(v => v > myValue).length;
        const equal = xs.filter(v => v === myValue).length;

        // Rank (1 = best) in descending order.
        // Use mid-rank for ties:
        // better = higher values, so rank starts after all higher values
        const rank = higher + 1; // simple rank (ties share same rank)
        const denom = (n - 1);

        // "besser als ..." = share of players below you
        const betterThanPct = Math.round((lower / denom) * 100);

        // "schlechter als ..." = share of players above you
        const worseThanPct = Math.round((higher / denom) * 100);

        // Decide which phrasing to show (always one of them)
        let text = "";
        if(lower >= higher){
            text = `Du performst besser als ${betterThanPct}% aller Spieler (Platz ${rank} von ${n}).`;
        }else{
            text = `Du performst schlechter als ${worseThanPct}% aller Spieler (Platz ${rank} von ${n}).`;
        }

        // If everyone is equal, be explicit:
        if(equal === n){
            text = `Alle performen aktuell gleich (Platz 1 von ${n}).`;
        }

        return { text, rank, n };
    }

    // Firestore: user doc + username
    async function ensureUserDocExists(uid){
        const ref = doc(db, "users", uid);
        const snap = await getDoc(ref);
        if(!snap.exists()){
            await setDoc(ref, {
                username: null,
                photoDataUrl: null,
                totalEUR: 0,
                tournamentTotalEUR: 0,
                cashgameTotalEUR: 0,
                entriesCountEUR: 0,
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp()
            }, { merge: true });
        }
    }

    async function isAdminUid(uid){
        const ref = doc(db, "admins", uid);
        const snap = await getDoc(ref);
        return snap.exists();
    }


    async function getUserDoc(uid){
        const ref = doc(db, "users", uid);
        const snap = await getDoc(ref);
        return snap.exists() ? snap.data() : null;
    }

    async function isUsernameTaken(username){
        const qU = query(collection(db, "users"), where("username", "==", username));
        const snap = await getDocs(qU);
        return !snap.empty;
    }

    async function setUsernameForUser(uid, username){
        await setDoc(doc(db, "users", uid), { username, updatedAt: serverTimestamp() }, { merge: true });
    }

    async function updateProfile(uid, { username, photoDataUrl }){
        const udoc = await getUserDoc(uid);
        const currentUsername = udoc?.username || null;

        if(username && username !== currentUsername){
            if(!isValidUsername(username)) throw new Error("Username ungültig (3–20 Zeichen, nur Buchstaben/Zahlen/_).");
            if(await isUsernameTaken(username)) throw new Error("Username ist bereits vergeben.");
        }

        await setDoc(doc(db, "users", uid), {
            username: username ?? currentUsername ?? null,
            photoDataUrl: photoDataUrl ?? (udoc?.photoDataUrl ?? null),
            updatedAt: serverTimestamp()
        }, { merge: true });
    }

    // Auth: Email/password
    loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        authMsg.textContent = "";

        const email = document.getElementById("loginEmail").value.trim();
        const pw = document.getElementById("loginPassword").value;

        try{
            await signInWithEmailAndPassword(auth, email, pw);
        }catch(err){
            authMsg.textContent = err?.message || "Login fehlgeschlagen.";
        }
    });

    registerForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        authMsg.textContent = "";

        const username = document.getElementById("regUsername").value.trim();
        const email = document.getElementById("regEmail").value.trim();
        const pw = document.getElementById("regPassword").value;

        if(!isValidUsername(username)){
            authMsg.textContent = "Username ungültig (3–20 Zeichen, nur Buchstaben/Zahlen/_).";
            return;
        }

        try{
            if(await isUsernameTaken(username)){
                authMsg.textContent = "Username ist bereits vergeben.";
                return;
            }

            const cred = await createUserWithEmailAndPassword(auth, email, pw);
            await ensureUserDocExists(cred.user.uid);

            await setDoc(doc(db, "users", cred.user.uid), {
                username,
                photoDataUrl: null,
                totalEUR: 0,
                tournamentTotalEUR: 0,
                cashgameTotalEUR: 0,
                entriesCountEUR: 0,
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp()
            }, { merge: true });

        }catch(err){
            authMsg.textContent = err?.message || "Registrierung fehlgeschlagen.";
        }
    });

    // Auth: Google + username enforcement
    let pendingGoogleUser = null;

    btnGoogle.addEventListener("click", async () => {
        authMsg.textContent = "";
        try{
            const provider = new GoogleAuthProvider();
            const cred = await signInWithPopup(auth, provider);

            await ensureUserDocExists(cred.user.uid);
            const udoc = await getUserDoc(cred.user.uid);

            if(!udoc || !udoc.username){
                pendingGoogleUser = cred.user;
                usernameInput.value = "";
                usernameError.textContent = "";
                usernameModal.show();
            }
        }catch(err){
            authMsg.textContent = err?.message || "Google Login fehlgeschlagen.";
        }
    });

    saveUsernameBtn.addEventListener("click", async () => {
        usernameError.textContent = "";
        const username = usernameInput.value.trim();

        if(!pendingGoogleUser){
            usernameError.textContent = "Interner Zustand ungültig. Bitte erneut einloggen.";
            return;
        }
        if(!isValidUsername(username)){
            usernameError.textContent = "Ungültig: 3–20 Zeichen, nur Buchstaben/Zahlen/_";
            return;
        }

        try{
            if(await isUsernameTaken(username)){
                usernameError.textContent = "Username ist bereits vergeben.";
                return;
            }

            await setUsernameForUser(pendingGoogleUser.uid, username);
            pendingGoogleUser = null;
            usernameModal.hide();
        }catch(err){
            usernameError.textContent = err?.message || "Speichern fehlgeschlagen.";
        }
    });

    btnLogout.addEventListener("click", async () => {
        await signOut(auth);
    });

    // Entries: add/delete + recompute totals
    async function addEntry(uid, entry){
        const ref = collection(db, "users", uid, "entries");
        await addDoc(ref, { ...entry, createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
    }

    async function deleteEntry(uid, entryId){
        await deleteDoc(doc(db, "users", uid, "entries", entryId));
    }

    async function recomputeAndWriteTotalsEUR(uid){
        const entriesSnap = await getDocs(collection(db, "users", uid, "entries"));
        let total=0, t=0, c=0, count=0;

        entriesSnap.forEach(d => {
            const e = d.data();
            if(e.currency !== "EUR") return;
            const amt = Number(e.amount || 0);
            total += amt;
            if(e.type === "tournament") t += amt;
            if(e.type === "cashgame") c += amt;
            count++;
        });

        await setDoc(doc(db, "users", uid), {
            totalEUR: total,
            tournamentTotalEUR: t,
            cashgameTotalEUR: c,
            entriesCountEUR: count,
            updatedAt: serverTimestamp()
        }, { merge: true });
    }

    // Add cash entry
    btnAddCash.addEventListener("click", async () => {
        cashMsg.textContent = "";
        if(!currentUser) return;

        const entry = {
            date: cashDate.value,
            type: "cashgame",
            amount: Math.round(Number(cashAmount.value) * 100) / 100,
            currency: "EUR",
            note: (cashNote.value || "").trim()
        };

        if(!entry.date || Number.isNaN(entry.amount)){
            cashMsg.textContent = "Bitte Datum und Betrag korrekt ausfüllen.";
            return;
        }

        try{
            await addEntry(currentUser.uid, entry);
            cashAmount.value = "";
            cashNote.value = "";
            await recomputeAndWriteTotalsEUR(currentUser.uid);
        }catch(err){
            cashMsg.textContent = err?.message || "Speichern fehlgeschlagen.";
        }
    });

    // Add tournament entry
    btnAddTour.addEventListener("click", async () => {
        tourMsg.textContent = "";
        if(!currentUser) return;

        const entry = {
            date: tourDate.value,
            type: "tournament",
            amount: Math.round(Number(tourAmount.value) * 100) / 100,
            currency: "EUR",
            note: (tourNote.value || "").trim()
        };

        if(!entry.date || Number.isNaN(entry.amount)){
            tourMsg.textContent = "Bitte Datum und Betrag korrekt ausfüllen.";
            return;
        }

        try{
            await addEntry(currentUser.uid, entry);
            tourAmount.value = "";
            tourNote.value = "";
            await recomputeAndWriteTotalsEUR(currentUser.uid);
        }catch(err){
            tourMsg.textContent = err?.message || "Speichern fehlgeschlagen.";
        }
    });

    // Rendering
    let currentUser = null;
    let unsubEntries = null;
    let unsubLeaderboards = null;

    let cashChart = null;
    let tourChart = null;

    function buildCumulativeChart(canvasId, entries){
        const sorted = entries.slice().sort((a,b)=> (a.date||"").localeCompare(b.date||""));
        const byDate = new Map();
        for(const e of sorted){
            byDate.set(e.date, (byDate.get(e.date) || 0) + Number(e.amount || 0));
        }
        const labels = Array.from(byDate.keys()).sort();
        let running = 0;
        const cumulative = labels.map(d => (running += byDate.get(d)));

        const ctx = document.getElementById(canvasId);
        return new Chart(ctx, {
            type: "line",
            data: { labels, datasets: [{ label: "Kumuliert", data: cumulative, tension: 0.25 }] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { labels: { color: "#e9eef5" } } },
                scales: {
                    x: { ticks: { color: "rgba(233,238,245,0.8)" }, grid: { color: "rgba(255,255,255,0.08)" } },
                    y: { ticks: { color: "rgba(233,238,245,0.8)" }, grid: { color: "rgba(255,255,255,0.08)" } }
                }
            }
        });
    }

    function renderTablesAndStats(allEntries){
        const eur = allEntries.filter(e => e.currency === "EUR");
        const cash = eur.filter(e => e.type === "cashgame");
        const tour = eur.filter(e => e.type === "tournament");

        // Overall KPI (header total)
        const total = eur.reduce((s,e)=> s + Number(e.amount||0), 0);
        kpiTotal.textContent = formatEUR(total);
        kpiTotal.className = "display-6 fw-semibold " + amountClass(total);

        // Cash stats
        const cashTotal = cash.reduce((s,e)=> s + Number(e.amount||0), 0);
        const cashCount = cash.length;
        const cashAvg = cashCount ? (cashTotal / cashCount) : 0;
        kpiCashTotal.textContent = formatEUR(cashTotal);
        kpiCashTotal.className = "h3 mb-0 " + amountClass(cashTotal);
        kpiCashCount.textContent = String(cashCount);
        kpiCashAvg.textContent = formatEUR(cashAvg);
        kpiCashAvg.className = "h4 mb-0 " + amountClass(cashAvg);

        // Tour stats
        const tourTotal = tour.reduce((s,e)=> s + Number(e.amount||0), 0);
        const tourCount = tour.length;
        const tourAvg = tourCount ? (tourTotal / tourCount) : 0;
        kpiTourTotal.textContent = formatEUR(tourTotal);
        kpiTourTotal.className = "h3 mb-0 " + amountClass(tourTotal);
        kpiTourCount.textContent = String(tourCount);
        kpiTourAvg.textContent = formatEUR(tourAvg);
        kpiTourAvg.className = "h4 mb-0 " + amountClass(tourAvg);

        // Cash table
        tbodyCash.innerHTML = cash
            .slice().sort((a,b)=> (b.date||"").localeCompare(a.date||""))
            .map(e => `
        <tr>
          <td>${escapeHtml(e.date||"")}</td>
          <td class="text-end ${amountClass(Number(e.amount||0))}">${formatEUR(Number(e.amount||0))}</td>
          <td class="small-muted">${escapeHtml(e.note||"")}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-danger" data-del="${escapeHtml(e.id)}" type="button">Löschen</button>
          </td>
        </tr>
      `).join("") || `<tr><td colspan="4" class="small-muted">Noch keine Cashgame-Einträge.</td></tr>`;

        // Tour table
        tbodyTour.innerHTML = tour
            .slice().sort((a,b)=> (b.date||"").localeCompare(a.date||""))
            .map(e => `
        <tr>
          <td>${escapeHtml(e.date||"")}</td>
          <td class="text-end ${amountClass(Number(e.amount||0))}">${formatEUR(Number(e.amount||0))}</td>
          <td class="small-muted">${escapeHtml(e.note||"")}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-danger" data-del="${escapeHtml(e.id)}" type="button">Löschen</button>
          </td>
        </tr>
      `).join("") || `<tr><td colspan="4" class="small-muted">Noch keine Turnier-Einträge.</td></tr>`;

        // Charts
        if(cashChart){ cashChart.destroy(); cashChart = null; }
        if(tourChart){ tourChart.destroy(); tourChart = null; }

        cashChart = buildCumulativeChart("cashChart", cash);
        tourChart = buildCumulativeChart("tourChart", tour);
    }

    // Delete handler for both tables
    document.addEventListener("click", async (e) => {
        const btn = e.target.closest("button[data-del]");
        if(!btn || !currentUser) return;

        const id = btn.getAttribute("data-del");
        if(!id) return;

        if(!confirm("Eintrag löschen?")) return;

        try{
            await deleteEntry(currentUser.uid, id);
            await recomputeAndWriteTotalsEUR(currentUser.uid);
        }catch(err){
            alert(err?.message || "Löschen fehlgeschlagen.");
        }
    });

    function renderPodium(slots, top3, key){
        function slotHtml(rank, user){
            if(!user){
                return `
          <div class="podium-rank" style="color: #fff;">#${rank}</div>
          <img class="podium-avatar" src="${defaultAvatarDataUrl()}" alt="Profilbild">
          <div class="podium-name small-muted" style="color: #fff;">—</div>
          <div class="podium-value small-muted">0,00 €</div>
        `;
            }
            const v = Number(user[key] || 0);
            const photo = user.photoDataUrl || defaultAvatarDataUrl();
            return `
        <div class="podium-rank" style="color: #fff;">#${rank}</div>
        <img class="podium-avatar" src="${escapeHtml(photo)}" alt="Profilbild">
        <div class="podium-name" style="color: #fff;">${escapeHtml(user.username || "—")}</div>
        <div class="podium-value ${amountClass(v)}">${formatEUR(v)}</div>
      `;
        }

        // 2–1–3 Darstellung (Layout), Daten: top3[0]=#1, top3[1]=#2, top3[2]=#3
        slots[1].innerHTML = slotHtml(1, top3[0] || null);
        slots[2].innerHTML = slotHtml(2, top3[1] || null);
        slots[3].innerHTML = slotHtml(3, top3[2] || null);
    }

    // Leaderboards + Performance (gegen alle anderen)
    // Performance basiert auf TOTAL (totalEUR) vs alle User totalEUR
    function listenLeaderboards(){
        const qCash = query(collection(db, "users"), orderBy("cashgameTotalEUR", "desc"));
        const qTour = query(collection(db, "users"), orderBy("tournamentTotalEUR", "desc"));
        const qTotal = query(collection(db, "users"), orderBy("totalEUR", "desc"));

        const unsubCash = onSnapshot(qCash, (snap) => {
            const users = snap.docs
                .map(d => ({ id: d.id, ...d.data() }))
                .filter(u => !!u.username);

            const top3 = users.slice(0, 3);
            renderPodium({1: podiumCash1, 2: podiumCash2, 3: podiumCash3}, top3, "cashgameTotalEUR");

            let rank = 3;
            const rows = users.slice(3, 50).map(u => {
                rank++;
                const v = Number(u.cashgameTotalEUR || 0);
                const photo = u.photoDataUrl || defaultAvatarDataUrl();
                return `
          <tr>
            <td>${rank}</td>
            <td>
              <div class="d-flex align-items-center">
                <img class="lb-avatar" src="${escapeHtml(photo)}" alt="Profilbild">
                <div class="fw-semibold">${escapeHtml(u.username)}</div>
              </div>
            </td>
            <td class="text-end ${amountClass(v)}">${formatEUR(v)}</td>
          </tr>
        `;
            }).join("");

            tbodyLeaderboardCash.innerHTML = rows.trim()
                ? rows
                : `<tr><td colspan="3" class="small-muted">Keine weiteren Plätze (ab #4).</td></tr>`;
        });

        const unsubTour = onSnapshot(qTour, (snap) => {
            const users = snap.docs
                .map(d => ({ id: d.id, ...d.data() }))
                .filter(u => !!u.username);

            const top3 = users.slice(0, 3);
            renderPodium({1: podiumTour1, 2: podiumTour2, 3: podiumTour3}, top3, "tournamentTotalEUR");

            let rank = 3;
            const rows = users.slice(3, 50).map(u => {
                rank++;
                const v = Number(u.tournamentTotalEUR || 0);
                const photo = u.photoDataUrl || defaultAvatarDataUrl();
                return `
          <tr>
            <td>${rank}</td>
            <td>
              <div class="d-flex align-items-center">
                <img class="lb-avatar" src="${escapeHtml(photo)}" alt="Profilbild">
                <div class="fw-semibold">${escapeHtml(u.username)}</div>
              </div>
            </td>
            <td class="text-end ${amountClass(v)}">${formatEUR(v)}</td>
          </tr>
        `;
            }).join("");

            tbodyLeaderboardTour.innerHTML = rows.trim()
                ? rows
                : `<tr><td colspan="3" class="small-muted">Keine weiteren Plätze (ab #4).</td></tr>`;
        });

        const unsubTotalBoard = onSnapshot(qTotal, (snap) => {
            const users = snap.docs
                .map(d => ({ id: d.id, ...d.data() }))
                .filter(u => !!u.username);

            const top3 = users.slice(0, 3);
            renderPodium({1: podiumTotal1, 2: podiumTotal2, 3: podiumTotal3}, top3, "totalEUR");

            let rank = 3;
            const rows = users.slice(3, 50).map(u => {
                rank++;
                const v = Number(u.totalEUR || 0);
                const photo = u.photoDataUrl || defaultAvatarDataUrl();
                return `
      <tr>
        <td>${rank}</td>
        <td>
          <div class="d-flex align-items-center">
            <img class="lb-avatar" src="${escapeHtml(photo)}" alt="Profilbild">
            <div class="fw-semibold">${escapeHtml(u.username)}</div>
          </div>
        </td>
        <td class="text-end ${amountClass(v)}">${formatEUR(v)}</td>
      </tr>
    `;
            }).join("");

            tbodyLeaderboardTotal.innerHTML = rows.trim()
                ? rows
                : `<tr><td colspan="3" class="small-muted">Keine weiteren Plätze (ab #4).</td></tr>`;
        });


        // Performance: mein totalEUR vs alle anderen totalEUR
        const unsubTotal = onSnapshot(qTotal, async (snap) => {
            if(!currentUser){
                kpiPerformance.textContent = "—";
                return;
            }

            // Take totals only from users that actually have a username (optional, but usually desired)
            const users = snap.docs
                .map(d => ({ id: d.id, ...d.data() }))
                .filter(u => !!u.username);

            const totals = users.map(u => Number(u.totalEUR || 0));

            // Get my total reliably (don’t depend on being in the same filtered list)
            const myFresh = await getUserDoc(currentUser.uid);
            const myTotal = Number(myFresh?.totalEUR || 0);

            const r = performanceVsAll(totals, myTotal);
            kpiPerformance.textContent = r.text;
        });


        return () => { unsubCash(); unsubTour(); unsubTotal(); unsubTotalBoard(); };
    }

    // Profile: open + file preview + save
    btnOpenProfile.addEventListener("click", async () => {
        profileMsg.textContent = "";
        if(!currentUser) return;

        const udoc = await getUserDoc(currentUser.uid);
        profileUsername.value = udoc?.username || "";
        profilePhotoFile.value = "";

        setNavProfile(udoc?.username || "", udoc?.photoDataUrl || null);
        profileModal.show();
    });

    let stagedPhotoDataUrl = null;
    profilePhotoFile.addEventListener("change", async (e) => {
        profileMsg.textContent = "";
        stagedPhotoDataUrl = null;

        const file = e.target.files?.[0];
        if(!file) return;

        if(!file.type.startsWith("image/")){
            profileMsg.textContent = "Bitte eine Bilddatei auswählen.";
            return;
        }

        try{
            const dataUrl = await fileToResizedDataUrl(file, 256, 0.82);
            stagedPhotoDataUrl = dataUrl;
            profilePreview.src = stagedPhotoDataUrl;
        }catch(err){
            profileMsg.textContent = "Bild konnte nicht verarbeitet werden.";
        }
    });

    btnSaveProfile.addEventListener("click", async () => {
        profileMsg.textContent = "";
        if(!currentUser) return;

        const desiredUsername = (profileUsername.value || "").trim();
        if(desiredUsername && !isValidUsername(desiredUsername)){
            profileMsg.textContent = "Username ungültig (3–20 Zeichen, nur Buchstaben/Zahlen/_).";
            return;
        }

        btnSaveProfile.disabled = true;
        try{
            await updateProfile(currentUser.uid, {
                username: desiredUsername || null,
                photoDataUrl: stagedPhotoDataUrl ?? undefined
            });

            const fresh = await getUserDoc(currentUser.uid);
            setNavProfile(fresh?.username || "", fresh?.photoDataUrl || null);
            whoAmI.textContent = `${fresh?.username || "(ohne username)"}`;

            profileModal.hide();
        }catch(err){
            profileMsg.textContent = err?.message || "Speichern fehlgeschlagen.";
        }finally{
            btnSaveProfile.disabled = false;
        }
    });

    // Resize helper
    function fileToResizedDataUrl(file, maxSizePx = 256, quality = 0.82){
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onerror = reject;
            reader.onload = () => {
                const img = new Image();
                img.onerror = reject;
                img.onload = () => {
                    const ratio = Math.min(1, maxSizePx / Math.max(img.width, img.height));
                    const w = Math.round(img.width * ratio);
                    const h = Math.round(img.height * ratio);

                    const canvas = document.createElement("canvas");
                    canvas.width = w;
                    canvas.height = h;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0, w, h);

                    const dataUrl = canvas.toDataURL("image/jpeg", quality);
                    resolve(dataUrl);
                };
                img.src = reader.result;
            };
            reader.readAsDataURL(file);
        });
    }

    // Auth State
    onAuthStateChanged(auth, async (user) => {
        currentUser = user || null;

        if(unsubEntries){ unsubEntries(); unsubEntries = null; }
        if(unsubLeaderboards){ unsubLeaderboards(); unsubLeaderboards = null; }

        if(!user){
            setAuthUI(false);
            whoAmI.textContent = "";
            authMsg.textContent = "";
            kpiPerformance.textContent = "—";

            tbodyCash.innerHTML = "";
            tbodyTour.innerHTML = "";
            tbodyLeaderboardCash.innerHTML = "";
            tbodyLeaderboardTour.innerHTML = "";

            podiumCash1.innerHTML = "";
            podiumCash2.innerHTML = "";
            podiumCash3.innerHTML = "";
            podiumTour1.innerHTML = "";
            podiumTour2.innerHTML = "";
            podiumTour3.innerHTML = "";


            tbodyLeaderboardTotal.innerHTML = "";

            podiumTotal1.innerHTML = "";
            podiumTotal2.innerHTML = "";
            podiumTotal3.innerHTML = "";


            navAvatar.src = defaultAvatarDataUrl();
            navUsername.textContent = "Profil";

            if(cashChart){ cashChart.destroy(); cashChart = null; }
            if(tourChart){ tourChart.destroy(); tourChart = null; }
            return;
        }

        await ensureUserDocExists(user.uid);
        const udoc = await getUserDoc(user.uid);

        if(!udoc || !udoc.username){
            pendingGoogleUser = user;
            usernameInput.value = "";
            usernameError.textContent = "";
            setAuthUI(true);
            setNavProfile("Profil", null);
            whoAmI.textContent = "Bitte Username festlegen, um fortzufahren.";
            kpiPerformance.textContent = "—";
            usernameModal.show();
            return;
        }

        setAuthUI(true);
        whoAmI.textContent = `${udoc.username}`;
        setNavProfile(udoc.username, udoc.photoDataUrl || null);

        const adminLink = document.getElementById("adminLink");
        const setupLink = document.getElementById("setupLink");

        const isAdmin = await isAdminUid(user.uid);
        adminLink.classList.toggle("d-none", !isAdmin);
        setupLink.classList.toggle("d-none", !isAdmin);


        // Listen to all my entries once, then split into cash/tour in UI
        const qMine = query(collection(db, "users", user.uid, "entries"), orderBy("date", "asc"));
        unsubEntries = onSnapshot(qMine, async (snap) => {
            const entries = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderTablesAndStats(entries);

            // refresh header total from user doc
            const fresh = await getUserDoc(user.uid);
            const total = Number(fresh?.totalEUR || 0);
            kpiTotal.textContent = formatEUR(total);
            kpiTotal.className = "display-6 fw-semibold " + amountClass(total);
        });

        unsubLeaderboards = listenLeaderboards();
    });
</script>

<script>
    if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
            navigator.serviceWorker.register("./sw.js");
        });
    }
</script>

</body>
</html>
